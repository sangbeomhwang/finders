<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>프로젝트 관리</title>
    <style>
/* 전체 스타일 설정 */
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    display: flex;
    height: 100vh;
    margin: 0;
    background-color: #f4f4f9;
    color: #333;
}

.container {
    background-color: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    text-align: center;
    margin: auto;
    width: 400px;
}

h1 {
    margin: 0 0 20px;
    font-size: 1.8rem;
    color: #333;
}

/* 버튼 스타일 */
.button {
    padding: 12px 25px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    margin-top: 10px;
    transition: all 0.3s ease;
    box-shadow: 0 3px 8px rgba(0, 123, 255, 0.2);
}

.button:hover {
    background-color: #0056b3;
    box-shadow: 0 4px 12px rgba(0, 91, 187, 0.3);
    transform: translateY(-2px);
}

/* 사이드바 스타일 */
.sidebar {
    width: 0;
    position: fixed;
    right: 0;
    top: 0;
    height: 100%;
    background-color: #2c3e50;
    overflow-x: hidden;
    transition: 0.5s;
    padding-top: 60px;
    z-index: 1000;
    box-shadow: -2px 0 5px rgba(0, 0, 0, 0.2);
}

.sidebar-content {
    display: flex;
    flex-direction: column;
    height: 100%;
    padding: 20px;
    color: white;
}

.closebtn {
    position: absolute;
    top: 20px;
    right: 25px;
    font-size: 36px;
    color: #ecf0f1;
    cursor: pointer;
}

/* 채팅방 목록 스타일 */
.chat-room-list {
    flex: 1;
    margin-top: 20px;
    overflow-y: auto;
    padding-right: 10px;
}

.chat-room-item {
    padding: 15px;
    background-color: #34495e;
    border-radius: 8px;
    margin-bottom: 10px;
    cursor: pointer;
    text-decoration: none;
    color: white;
    display: block;
    transition: background-color 0.3s, transform 0.2s;
}

.chat-room-item:hover {
    background-color: #3b5998;
    transform: translateY(-2px);
}

/* 모달 스타일 */
.modal {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: #ffffff;
    padding: 20px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    border-radius: 12px;
    width: 450px;
    max-height: 80vh;
    overflow-y: auto;
    z-index: 1001;
}

.overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 1000;
}

/* 모달 닫기 버튼 */
.button-close {
    padding: 10px 15px;
    background-color: #dc3545;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s;
    margin-top: 15px;
    position: absolute;
    top: 10px;
    right: 10px;
}

.button-close:hover {
    background-color: #c82333;
}

/* 메시지 입력창 스타일 */
.message-input {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.message-input input {
    flex: 1;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 1rem;
}

.send-button {
    background-color: #28a745;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s;
}

.send-button:hover {
    background-color: #218838;
}

/* 메시지 구별 스타일 */
.messages {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.message {
    padding: 10px;
    border-radius: 8px;
    max-width: 70%;
    word-wrap: break-word;
    color: #fff;
}

.message.sent {
    background-color: #007bff;
    align-self: flex-end;
}

.message.received {
    background-color: #f1f1f1;
    color: #333;
    align-self: flex-start;
}

/* 멤버 및 프로젝트 리스트 스타일 */
.members-list,
.projects-list {
    max-height: 150px;
    overflow-y: auto;
    padding: 0;
    margin: 10px 0;
    border: 1px solid #ddd;
    border-radius: 5px;
}

.members-list li,
.projects-list li {
    padding: 10px;
    cursor: pointer;
    border-bottom: 1px solid #ddd;
    transition: background-color 0.3s;
    color: #333;
    border-radius: 5px;
}

.members-list li:hover,
.projects-list li:hover {
    background-color: #f1f1f1;
}

/* 모달 헤더 스타일 */
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #ddd;
    padding: 10px 20px;
    margin-bottom: 10px;
}

.modal ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.modal li {
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-bottom: 5px;
    cursor: pointer;
    transition: background-color 0.3s;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal li:hover {
    background-color: #f4f6f8;
}

.modal .selected {
    background-color: #007bff;
    color: white;
}

.deletebutton {
    padding: 8px 12px;
    background-color: #ff4d4f;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s;
}

.deletebutton:hover {
    background-color: #d32f2f;
}
    </style>
</head>
<body>

    <!-- 메인 컨텐츠 -->
    <div class="container">
        <h1>프로젝트 관리</h1>
        <button class="button" onclick="openSidebar()">채팅방 목록</button>
    </div>

    <!-- 사이드바 -->
    <div id="chatSidebar" class="sidebar">
        <span class="closebtn" onclick="closeSidebar()">&times;</span>
        <div class="sidebar-content">
            <button class="button" onclick="openCreateChatRoomModal()">채팅방 만들기</button>
            <div id="chatRoomsContent" class="chat-room-list">
                <!-- 채팅방 목록이 여기에 로드됩니다. -->
            </div>
        </div>
    </div>

	<!-- 채팅방 모달 -->
	<div class="overlay" id="chatOverlay" onclick="closeChatModal()"></div>
	<div id="chatModal" class="modal">
	    <h3 id="chatroomTitle"></h3>
	    <div class="button-container">
	        <button class="button" onclick="openParticipantsModal()">멤버 보기</button>
	    </div>
	    <div id="chatroom-data" data-chatroom-id="" data-member-id="" data-project-num=""></div>
	    <div class="chat-container">
	        <div id="messages" class="messages"></div>
	        <div class="message-input">
	            <input type="text" id="messageInput" placeholder="메시지를 입력하세요..." />
	            <button id="sendMessageButton" class="send-button">전송</button>
	        </div>
	    </div>
	    <button class="button-close" onclick="closeChatModal()">닫기</button>
	</div>
	
	<!-- 멤버 보기 모달 -->
	<div id="participantsModal" class="modal">
	    <div class="modal-header">
	        <h3>참가자 목록</h3>
	        <div class="button-container">
	            <button class="button" onclick="openInviteModal()">채팅방 초대</button>
	            <button class="deletebutton" onclick="closeParticipantsModal()">닫기</button>
	        </div>
	    </div>
	    <div class="modal-content">
	        <ul id="participantList"></ul>
	    </div>
	</div>
    
    
	  <!-- 초대 모달 -->
	<div id="inviteModal" class="modal">
	    <div class="modal-header">
	        <h3>참가자 목록</h3>
	        <div class="button-container">
	            <button class="button" onclick="openInviteModal()">채팅방 초대</button>
	            <button class="deletebutton" onclick="closeInviteModal()">닫기</button> <!-- Use correct function for closing -->
	        </div>
	    </div>
	    <div class="modal-content">
	        <ul id="inviteList"></ul>
	    </div>
	</div>

    <div class="overlay" id="overlay"></div>
    
    
    <!-- 채팅방 만들기 모달 -->
    <div class="overlay" id="overlay" onclick="closeModal()"></div>
    <div id="createChatRoomModal" class="modal">
        <h2>채팅방 생성</h2>
        <!-- 프로젝트 목록이 표시될 영역 -->
        <div id="projectList">
            <p>참여 중인 프로젝트 목록:</p>
            <ul id="projects"></ul>
        </div>
        <!-- 팀원 목록이 표시될 영역 -->
        <div id="teamMemberList" style="display: none;">
            <p>프로젝트에 참여 중인 팀원 목록:</p>
            <ul id="members"></ul>
        </div>
        <!-- 채팅방 이름 입력 필드 추가 -->
        <div class="input-container" id="chatRoomNameContainer" style="display: none;">
            <label for="chatRoomName">채팅방 이름을 입력하세요:</label>
            <input type="text" id="chatRoomName" placeholder="채팅방 이름">
        </div>
        <!-- 버튼을 같은 행에 배치 -->
        <div class="button-row">
            <button class="button-small" id="createChatRoomButton" onclick="window.createChatRoom()" style="display: none;">채팅방 생성</button>
            <button class="button-small close" onclick="closeModal()">닫기</button>
        </div>
    </div>

    <script src="/webjars/sockjs-client/1.0.2/sockjs.min.js"></script>
    <script src="/webjars/stomp-websocket/2.3.3/stomp.min.js"></script>
<script>
//전역 변수 선언
let selectedMembers = [];
let selectedProjectNum = null;
let stompClients = {};

// 사이드바 열기
function openSidebar() {
    document.getElementById("chatSidebar").style.width = "300px";
    updateChatRoomList();
}

// 사이드바 닫기
function closeSidebar() {
    document.getElementById("chatSidebar").style.width = "0";
}

// 채팅방 목록 업데이트
function updateChatRoomList() {
    fetch('/chat/getChatRooms')
        .then(response => response.json())
        .then(chatrooms => {
            const chatRoomsContent = document.getElementById('chatRoomsContent');
            chatRoomsContent.innerHTML = '';
            chatrooms.forEach(room => {
                const roomLink = document.createElement('a');
                roomLink.classList.add('chat-room-item');
                roomLink.textContent = room.chatroomName;
                roomLink.href = '#';
                roomLink.onclick = (event) => {
                    event.preventDefault();
                    openChatRoom(room.chatroomId, room.chatroomName);
                };
                chatRoomsContent.appendChild(roomLink);
            });
        })
        .catch(error => {
            console.error('Error fetching chat rooms:', error);
            alert('채팅방 목록을 불러오는 중 오류가 발생했습니다.');
        });
}

function openChatRoom(chatroomId, chatroomName) {
    if (!chatroomId) {
        console.error('Invalid chatroomId:', chatroomId);
        return;
    }

    // chatroomId에 맞는 projectNum을 서버에서 가져오는 로직 추가
    fetch(`/chat/getProjectNum?chatroomId=${chatroomId}`)
        .then(response => response.json())
        .then(data => {
            const projectNum = data.projectNum; // 서버에서 받아온 projectNum 설정
            if (projectNum) {
                selectedProjectNum = projectNum; // 받아온 projectNum을 selectedProjectNum에 설정
                document.getElementById('chatroom-data').setAttribute('data-project-num', selectedProjectNum);
                console.log('Selected projectNum set in chatroom-data:', selectedProjectNum);
            } else {
                console.error('Could not fetch projectNum for chatroomId:', chatroomId);
            }
        })
        .catch(error => {
            console.error('Error fetching projectNum:', error);
        });

    document.getElementById('chatOverlay').style.display = 'block';
    document.getElementById('chatModal').style.display = 'block';
    document.getElementById('chatroomTitle').textContent = chatroomName;
    document.getElementById('chatroom-data').setAttribute('data-chatroom-id', chatroomId);

    document.getElementById('messages').innerHTML = '';
    loadPreviousMessages(chatroomId);
    connectWebSocket(chatroomId);
}

// 채팅방 모달 닫기
function closeChatModal() {
    document.getElementById('chatOverlay').style.display = 'none';
    document.getElementById('chatModal').style.display = 'none';

    const chatroomElement = document.getElementById('chatroom-data');
    const chatroomId = chatroomElement.getAttribute('data-chatroom-id');

    if (stompClients[chatroomId]) {
        stompClients[chatroomId].disconnect(() => {
            console.log(`Disconnected from chatroom ${chatroomId}`);
        });
        delete stompClients[chatroomId];
    }
}

// WebSocket 연결 설정
function connectWebSocket(chatroomId) {
    if (!chatroomId) {
        console.error('chatroomId is undefined in connectWebSocket');
        return;
    }

    if (stompClients[chatroomId]) {
        console.log(`Already connected to chatroom ${chatroomId}`);
        return;
    }

    const socket = new SockJS('/ws/chat');
    const stompClient = Stomp.over(socket);

    stompClient.connect({}, function (frame) {
        console.log('Connected: ' + frame);
        stompClient.subscribe(`/topic/messages/${chatroomId}`, function (message) {
            const messageData = JSON.parse(message.body);
            displayMessage(messageData, chatroomId);
        });

        stompClients[chatroomId] = stompClient;
        console.log(`Connected to chatroom ${chatroomId}`);
    }, function (error) {
        console.error('WebSocket connection error:', error);
        alert('서버와의 연결에 문제가 발생했습니다. 다시 시도해주세요.');
    });
}

// 메시지 전송
document.getElementById('sendMessageButton').onclick = function () {
    const messageInput = document.getElementById('messageInput');
    const messageContent = messageInput.value;
    const memberId = document.getElementById('chatroom-data').getAttribute('data-member-id');
    const chatroomId = document.getElementById('chatroom-data').getAttribute('data-chatroom-id');

    if (messageContent.trim() !== '' && stompClients[chatroomId]) {
        const messageData = {
            chatroomId: parseInt(chatroomId),
            senderId: memberId,
            messageContents: messageContent,
            sendTime: new Date().toISOString()
        };
        stompClients[chatroomId].send('/app/send', {}, JSON.stringify(messageData));
        messageInput.value = '';
    }
};

// 메시지 표시
function displayMessage(message, chatroomId) {
    const currentChatroomId = document.getElementById('chatroom-data').getAttribute('data-chatroom-id');
    if (message.chatroomId != currentChatroomId) {
        return;
    }

    const messageContainer = document.getElementById('messages');
    const messageElement = document.createElement('div');
    messageElement.classList.add('message');

    const memberId = document.getElementById('chatroom-data').getAttribute('data-member-id');
    if (message.senderId === memberId) {
        messageElement.classList.add('mine');
    } else {
        messageElement.classList.add('others');
    }

    messageElement.innerHTML = `<p class="sender">${message.senderId}</p>
                                <p>${message.messageContents}</p>
                                <p class="timestamp">${new Date(message.sendTime).toLocaleString()}</p>`;
    messageContainer.appendChild(messageElement);
    messageContainer.scrollTop = messageContainer.scrollHeight;
}

// 이전 메시지 로드
function loadPreviousMessages(chatroomId) {
    fetch(`/chat/messages?chatroomId=${chatroomId}`)
        .then(response => response.json())
        .then(messages => {
            messages.forEach(message => displayMessage(message, chatroomId));
        })
        .catch(error => {
            console.error('Failed to load messages:', error);
        });
}

// 참가자 모달 열기
function openParticipantsModal() {
    const chatroomId = document.getElementById('chatroom-data').getAttribute('data-chatroom-id');

    if (!chatroomId || isNaN(chatroomId)) {
        console.error('유효하지 않은 chatroomId:', chatroomId);
        alert('유효한 채팅방 ID가 필요합니다.');
        return;
    }

    fetch(`/chat/participants?chatroomId=${chatroomId}`)
        .then(response => response.json())
        .then(participants => {
            const participantList = document.getElementById('participantList');
            participantList.innerHTML = '';
            participants.forEach(participant => {
                const li = document.createElement('li');
                li.textContent = participant;
                participantList.appendChild(li);
            });
            document.getElementById('participantsModal').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        })
        .catch(error => {
            console.error('Failed to load participants:', error);
            alert('참가자 목록을 불러오는 중 오류가 발생했습니다.');
        });
}

// 참가자 모달 닫기
function closeParticipantsModal() {
    document.getElementById('participantsModal').style.display = 'none';
    document.getElementById('overlay').style.display = 'none';
}

function openInviteModal() {
    const projectNum = document.getElementById('chatroom-data').getAttribute('data-project-num');
    const chatroomId = document.getElementById('chatroom-data').getAttribute('data-chatroom-id');

    // projectNum과 chatroomId가 올바르게 설정되었는지 확인
    if (!projectNum || isNaN(projectNum) || !chatroomId || isNaN(chatroomId)) {
        alert('유효한 프로젝트 번호 또는 채팅방 ID가 필요합니다.');
        return;
    }

    fetch(`/chat/getAvailableTeamMembers?projectNum=${projectNum}&chatroomId=${chatroomId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to load members'); // 서버에서 오류가 발생한 경우 예외 처리
            }
            return response.json();
        })
        .then(members => {
            const inviteList = document.getElementById('inviteList');
            if (!inviteList) {
                console.error('Invite list element not found'); // 요소가 없을 때의 처리
                return;
            }
            inviteList.innerHTML = '';
            if (!Array.isArray(members)) {
                alert('멤버 목록을 불러오는 중 오류가 발생했습니다.');
                return;
            }

            members.forEach(member => {
                const li = document.createElement('li');
                li.textContent = member;
                if (member.includes('(참가 중)')) {
                    li.style.color = 'grey';
                    li.style.pointerEvents = 'none';
                } else {
                    li.onclick = () => inviteMember(member.replace(' (참가 중)', ''), li);
                }
                inviteList.appendChild(li);
            });

            document.getElementById('inviteModal').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        })
        .catch(error => {
            console.error('Failed to load members:', error);
            alert('멤버 목록을 불러오는 중 오류가 발생했습니다.');
        });
}

// 초대 모달 닫기
function closeInviteModal() {
    document.getElementById('inviteModal').style.display = 'none';
    document.getElementById('overlay').style.display = 'none';
    closeParticipantsModal();
}

// 멤버 초대
function inviteMember(memberId, element) {
    const chatroomId = document.getElementById('chatroom-data').getAttribute('data-chatroom-id');
    fetch(`/chat/invite`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ chatroomId, memberId })
    })
    .then(response => {
        if (response.ok) {
            alert(`${memberId}님이 초대되었습니다.`);
            element.classList.add('selected');
            closeInviteModal();
            closeParticipantsModal();
            sendSystemMessage(`${memberId}님이 채팅방에 초대되었습니다.`);
        } else {
            alert('초대 실패');
        }
    })
    .catch(error => {
        console.error('Failed to invite member:', error);
        alert('초대 중 오류가 발생했습니다.');
    });
}

// 시스템 메시지 전송
function sendSystemMessage(content) {
    const chatroomId = document.getElementById('chatroom-data').getAttribute('data-chatroom-id');
    const messageData = {
        chatroomId: parseInt(chatroomId),
        senderId: "System",
        messageContents: content,
        sendTime: new Date().toISOString()
    };

    if (stompClients[chatroomId]) {
        stompClients[chatroomId].send('/app/send', {}, JSON.stringify(messageData));
    }
}

// 채팅방 생성
window.createChatRoom = function () {
    const chatRoomNameInput = document.getElementById('chatRoomName');
    const createChatRoomButton = document.getElementById('createChatRoomButton');

    const chatRoomName = chatRoomNameInput.value.trim();
    if (!selectedProjectNum) {
        alert('프로젝트를 선택하세요.');
        return;
    }
    if (selectedMembers.length === 0) {
        alert('최소 한 명 이상의 팀원을 선택하세요.');
        return;
    }
    if (!chatRoomName) {
        alert('채팅방 이름을 입력하세요.');
        return;
    }

    fetch('/chat/createChatRoom', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            projectNum: selectedProjectNum,
            selectedMemberIds: selectedMembers,
            chatRoomName: chatRoomName
        })
    })
    .then(response => {
        if (response.ok) {
            alert('채팅방이 생성되었습니다.');
            updateChatRoomList();
            closeModal();
        } else {
            alert('채팅방 생성 실패');
        }
    })
    .catch(error => {
        console.error('Error creating chat room:', error);
        alert('채팅방 생성 중 오류가 발생했습니다.');
    });
};

// 모달 닫기
window.closeModal = function () {
    const modal = document.getElementById('createChatRoomModal');
    const overlay = document.getElementById('overlay');
    const chatRoomNameInput = document.getElementById('chatRoomName');

    modal.style.display = 'none';
    overlay.style.display = 'none';
    selectedProjectNum = null;
    selectedMembers = [];
    chatRoomNameInput.value = '';
    document.getElementById('teamMemberList').style.display = 'none';
    document.getElementById('chatRoomNameContainer').style.display = 'none';
    createChatRoomButton.style.display = 'none';
};

// 자동으로 채팅방 목록 업데이트 (5초마다)
setInterval(updateChatRoomList, 5000);

// 초기화 및 모달 열기 함수
document.addEventListener('DOMContentLoaded', function () {
    window.openCreateChatRoomModal = function () {
        fetch('/chat/getProjects')
            .then(response => response.json())
            .then(data => {
                const projects = Array.isArray(data) ? data : Object.values(data);
                const projectList = document.getElementById('projects');
                projectList.innerHTML = '';

                projects.forEach(project => {
                    const projectElement = document.createElement('li');
                    projectElement.textContent = `프로젝트 번호: ${project.projectNum}, 프로젝트 이름: ${project.projectName}`;
                    projectElement.onclick = () => selectProject(project.projectNum, projectElement);
                    projectList.appendChild(projectElement);
                });

                document.getElementById('createChatRoomModal').style.display = 'block';
                document.getElementById('overlay').style.display = 'block';
            })
            .catch(error => console.error('Error fetching projects:', error));
    };

    function selectProject(projectNum, element) {
        const projectListItems = document.querySelectorAll('#projects li');
        projectListItems.forEach(item => item.classList.remove('selected'));
        element.classList.add('selected');
        selectedProjectNum = projectNum;

        // 선택된 프로젝트 번호를 로그로 출력하여 확인
        console.log('Selected projectNum:', selectedProjectNum);

        fetch(`/chat/getTeamMembers?projectNum=${projectNum}`)
            .then(response => response.json())
            .then(data => {
                if (!Array.isArray(data) || data.length === 0) {
                    alert('팀원 목록을 불러오지 못했습니다.');
                    return;
                }

                const memberList = document.getElementById('members');
                memberList.innerHTML = '';
                selectedMembers = [];

                data.forEach(member => {
                    const memberElement = document.createElement('li');
                    memberElement.textContent = member;
                    memberElement.onclick = () => toggleMemberSelection(member, memberElement);
                    memberList.appendChild(memberElement);
                });

                document.getElementById('teamMemberList').style.display = 'block';
            })
            .catch(error => {
                console.error('Error fetching team members:', error);
                alert('팀원 목록을 불러오는 중 오류가 발생했습니다.');
            });
    }

    function toggleMemberSelection(memberId, element) {
        if (selectedMembers.includes(memberId)) {
            selectedMembers = selectedMembers.filter(id => id !== memberId);
            element.classList.remove('selected');
        } else {
            selectedMembers.push(memberId);
            element.classList.add('selected');
        }

        if (selectedMembers.length > 0) {
            document.getElementById('chatRoomNameContainer').style.display = 'block';
            createChatRoomButton.style.display = 'block';
        } else {
            document.getElementById('chatRoomNameContainer').style.display = 'none';
            createChatRoomButton.style.display = 'none';
        }
    }
});
</script>

   


</body>
</html>
