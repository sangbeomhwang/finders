<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>클라이언트 평가</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .title {
            text-align: center;
            font-size: 24px;
            margin-bottom: 20px;
        }

        .subtitle {
            font-size: 18px;
            margin-bottom: 10px;
            text-align: center;
        }

        .stars {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-bottom: 10px;
        }

        .star {
            font-size: 30px;
            cursor: pointer;
            color: #ccc;
        }

        .star::before {
            content: '\2605'; /* 유니코드 별 모양 */
            color: #ccc; /* 기본 색상 */
        }

        .star.selected::before {
            color: #f39c12; /* 선택된 상태의 노란색 */
        }

        .checkbox-group {
            margin-bottom: 20px;
            text-align: center;
        }

        .checkbox-group p {
            margin-bottom: 10px;
            font-size: 20px;
            font-weight: 700;
        }

        .checkbox-group label {
            display: inline-block;
            margin: 5px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            user-select: none;
            background-color: #f9f9f9;
            transition: background-color 0.2s;
        }

        .checkbox-group input {
            display: none;
        }

        .checkbox-group input:checked + label {
            background-color: #d1ecf1;
            border-color: #007bff;
        }

        .comment-box {
            margin-bottom: 20px;
        }

        .comment-box textarea {
            width: 100%;
            height: 80px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: none; /* 크기 조정 불가능 */
        }

        .buttons {
            display: flex;
            justify-content: space-between;
        }

        .button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        .button.submit {
            background-color: #28a745;
            color: white;
        }

        .button.cancel {
            background-color: #dc3545;
            color: white;
        }

        .button:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">클라이언트 평가</h1>

        <div id="review-data" data-project-num="${projectNum}" data-client-id="${clientId}"></div>

        <!-- 참가자 선택 박스 -->
        <div class="participant-selection">
            <label for="participantSelect">평가할 참가자를 선택하세요:</label>
            <select id="participantSelect">
                <!-- 서버에서 가져온 참가자 목록이 추가됩니다 -->
            </select>
        </div>
        <br><br>

        <!-- 프로젝트 만족도 평가 -->
        <p class="subtitle">프로젝트는 만족하셨나요?</p>
        <div class="stars">
            <span class="star" data-value="1"></span>
            <span class="star" data-value="2"></span>
            <span class="star" data-value="3"></span>
            <span class="star" data-value="4"></span>
            <span class="star" data-value="5"></span>
        </div>
        <p id="rating-text" style="text-align: center;">선택하세요.</p>

        <!-- 클라이언트에 대한 평가 항목 -->
        <br>
        <div class="checkbox-group">
            <p>어떤 점이 마음에 드셨나요?</p>
            <p id="optional-text">(최대 5개 선택 가능, 선택은 필수가 아닙니다)</p>
            <input type="checkbox" id="item1" value="응답이 빨라요"><label for="item1">응답이 빨라요</label>
            <input type="checkbox" id="item2" value="일정에 맞춰 작업을 완료해요"><label for="item2">일정에 맞춰 작업을 완료해요</label>
            <input type="checkbox" id="item3" value="친절하고 협조적이에요"><label for="item3">친절하고 협조적이에요</label>
            <input type="checkbox" id="item4" value="작업 퀄리티가 높아요"><label for="item4">작업 퀄리티가 높아요</label>
            <input type="checkbox" id="item5" value="기술적 문제를 잘 해결해요"><label for="item5">기술적 문제를 잘 해결해요</label>
            <input type="checkbox" id="item6" value="전문성이 뛰어나요"><label for="item6">전문성이 뛰어나요</label>
            <input type="checkbox" id="item7" value="요구사항을 정확히 반영해요"><label for="item7">요구사항을 정확히 반영해요</label>
            <input type="checkbox" id="item8" value="유연하게 대응해요"><label for="item8">유연하게 대응해요</label>
            <input type="checkbox" id="item9" value="세부 사항까지 꼼꼼해요"><label for="item9">세부 사항까지 꼼꼼해요</label>
            <input type="checkbox" id="item10" value="상세한 피드백을 제공해요"><label for="item10">상세한 피드백을 제공해요</label>
        </div>

        <!-- 평가 코멘트 입력 -->
        <div class="comment-box">
            <textarea placeholder="어떤 점이 좋았나요?"></textarea>
        </div>

        <!-- 버튼 그룹 -->
        <div class="buttons">
            <button class="button cancel" onclick="window.location.href='/project/list';">취소</button>
            <button class="button submit">등록</button>
        </div>
    </div>

    <script>
    function loadParticipantData() {
        const projectNum = getProjectNum();

        if (!projectNum) {
            alert('프로젝트 번호가 없습니다.');
            return;
        }

        fetch('/member/getMemberId')
            .then(response => response.json())
            .then(data => {
                const clientId = data.memberId;
                const reviewDataDiv = document.getElementById('review-data');
                reviewDataDiv.dataset.projectNum = projectNum;
                reviewDataDiv.dataset.clientId = clientId;

                // 참가자 목록을 서버에서 가져오기
                fetch(`/review/getParticipants?projectNum=${projectNum}`)
                    .then(response => response.json())
                    .then(data => {
                        const participantSelect = document.getElementById('participantSelect');

                        if (Array.isArray(data)) {
                            participantSelect.innerHTML = '';
                            data.forEach(participant => {
                                // 참가자 데이터 출력
                                console.log('Participant Data:', participant);

                                const option = document.createElement('option');
                                option.value = participant.id; // 참가자 ID
                                option.textContent = participant.name; // 참가자 이름

                                // 작성 완료 여부에 따라 상태 설정
                                if (participant.reviewCompleted) { // reviewCompleted로 변경
                                    option.textContent += ' (작성 완료)'; // 작성 완료 표시
                                    option.disabled = true; // 작성 완료된 경우 선택 불가
                                }

                                participantSelect.appendChild(option);
                            });
                        } else {
                            console.error('Invalid participants data format.');
                            alert('참가자 데이터를 불러오는 중 오류가 발생했습니다.');
                        }
                    })
                    .catch(error => {
                        console.error('참가자 데이터 로드 중 오류:', error);
                        alert('참가자 데이터를 불러오는 중 오류가 발생했습니다.');
                    });
            })
            .catch(error => {
                console.error('클라이언트 ID 로드 중 오류:', error);
                alert('클라이언트 ID를 불러오는 중 오류가 발생했습니다.');
            });
    }


        document.addEventListener('DOMContentLoaded', loadParticipantData);

        // URL에서 projectNum 가져오는 함수
        function getProjectNum() {
            const urlParams = new URLSearchParams(window.location.search);
            const projectNum = urlParams.get('projectNum');
            console.log('Fetched Project Number:', projectNum); // 콘솔에 projectNum 출력
            return projectNum;
        }

        // URL에서 파라미터 추출 함수
        function getParameterByName(name) {
            const url = new URL(window.location.href);
            return url.searchParams.get(name);
        }

        // 페이지 로드 시 데이터 로드
        document.addEventListener('DOMContentLoaded', loadParticipantData);

        
        
        // 별점 선택 기능
        document.querySelectorAll('.star').forEach(star => {
            star.addEventListener('click', () => {
                let rating = parseFloat(star.getAttribute('data-value'));
                document.getElementById('rating-text').textContent = `${rating}점`;

                // 모든 별을 비활성화
                document.querySelectorAll('.star').forEach(s => s.classList.remove('selected'));

                // 선택한 별까지 활성화
                document.querySelectorAll('.star').forEach(s => {
                    if (parseFloat(s.getAttribute('data-value')) <= rating) {
                        s.classList.add('selected');
                    }
                });
            });
        });

        // 체크박스 선택 제한 (최대 5개까지)
        const checkboxes = document.querySelectorAll('.checkbox-group input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                if (document.querySelectorAll('.checkbox-group input[type="checkbox"]:checked').length > 5) {
                    checkbox.checked = false;
                    alert('최대 5개 항목만 선택할 수 있습니다.');
                }
            });
        });


        document.querySelector('.submit').addEventListener('click', () => {
            const reviewDataDiv = document.getElementById('review-data');
            const projectNum = getProjectNum(); // data-project-num에서 가져오기
            const clientId = reviewDataDiv.dataset.clientId; // data-client-id에서 가져오기
            const participantId = document.getElementById('participantSelect').value; // 참가자 ID
            
            // 값이 제대로 설정되었는지 검증
            if (!projectNum || !clientId || !participantId) {
                alert('참가자를 선택해주세요.');
                console.log('프로젝트 번호:', projectNum);
                console.log('클라이언트 ID:', clientId);
                console.log('참가자 ID:', participantId);
                return;
            }

            const ratingText = document.getElementById('rating-text').textContent;
            const rating = parseFloat(ratingText.replace('점', ''));
            const comment = document.querySelector('.comment-box textarea').value;
            const selectedItems = Array.from(document.querySelectorAll('.checkbox-group input[type="checkbox"]:checked'))
                .map(checkbox => ({ itemName: checkbox.value, selected: true }));

            // 별점과 코멘트 입력 여부 검증
            if (isNaN(rating) || rating === 0) {
                alert('프로젝트 만족도를 선택해주세요.');
                return;
            }
            if (!comment.trim()) {
                alert('평가 코멘트를 입력해주세요.');
                return;
            }

            // 등록 전 경고 문구 표시
            const confirmRegistration = confirm("한 번 등록한 평가는 수정할 수 없습니다. 계속하시겠습니까?");
            if (!confirmRegistration) {
                return; // 사용자가 확인을 누르지 않으면 등록 중단
            }

            // 서버로 데이터 전송
            console.log('전송할 데이터:', {
                projectNum: parseInt(projectNum, 10),
                clientId: clientId,
                freelancerId: participantId,
                rating: rating || 0,
                comment: comment,
                reviewItems: selectedItems
            });

            fetch('/review/submitClientReview', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    projectNum: parseInt(projectNum, 10),
                    clientId: clientId,
                    freelancerId: participantId, // 참가자 ID
                    rating: rating || 0,
                    comment: comment,
                    reviewItems: selectedItems
                })
            })
            .then(response => {
                if (response.ok) {
                    alert('리뷰가 제출되었습니다.');
                    window.location.href = '/project/list'; // 실제 리스트 페이지 URL로 수정하세요
                } else {
                    response.text().then(text => alert(`리뷰 제출에 실패했습니다: ${text}`));
                }
            })
            .catch(error => {
                console.error('리뷰 제출 오류:', error);
                alert('리뷰 제출 중 오류가 발생했습니다.');
            });
        });
        // 페이지 로드 시 데이터 로드
        document.addEventListener('DOMContentLoaded', loadParticipantData);

    </script>
</body>
</html>
